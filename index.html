<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>절대방어 쇼핑</title>
    
    <!-- Google Analytics 동적 로드 (CORB 오류 해결) -->
    <script>
    // Google Analytics 동적 로드 함수
    function loadGoogleAnalytics() {
        console.log('Google Analytics 동적 로드 시작...');
        
    // 환경별 측정 ID 자동 선택
    const isLocalhost = window.location.hostname === 'localhost' || 
                       window.location.hostname === '127.0.0.1';
    
    const measurementId = 'G-BVJPXJP2T9';  // 모든 환경에서 Netlify ID 사용
    
    console.log('현재 환경:', isLocalhost ? '로컬 개발' : '프로덕션');
    console.log('사용할 측정 ID:', measurementId, '(Netlify ID 통일)');
    
    const script = document.createElement('script');
    script.async = true;
    script.src = `https://www.googletagmanager.com/gtag/js?id=${measurementId}`;
        
        script.onload = function() {
            console.log('Google Analytics 스크립트 로드 성공');
            
            // gtag 함수 정의
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            window.gtag = gtag;
            
            gtag('js', new Date());
            gtag('config', measurementId, {
                page_title: '절대방어 쇼핑 - 가격비교 사이트',
                page_location: window.location.href,
                send_page_view: true,
                anonymize_ip: false,
                allow_google_signals: true,
                allow_ad_personalization_signals: false,
                debug_mode: true
            });
            
            console.log('Google Analytics 초기화 완료');
            
            // 즉시 페이지뷰 이벤트 전송
            gtag('event', 'page_view', {
                page_title: '절대방어 쇼핑 - 가격비교 사이트',
                page_location: window.location.href,
                page_path: window.location.pathname
            });
            
            console.log('초기 페이지뷰 이벤트 전송 완료');
        };
        
        script.onerror = function() {
            console.error('Google Analytics 스크립트 로드 실패 - CORB 차단됨');
            console.log('대체 추적 방법을 사용합니다...');
            
            // 대체 추적 방법 (Measurement Protocol)
            initFallbackTracking();
        };
        
        document.head.appendChild(script);
    }
    
    // 로컬 스토리지 기반 추적 시스템
    function initFallbackTracking() {
        console.log('로컬 스토리지 추적 시스템 초기화...');
        
        // 클라이언트 ID 생성
        function generateClientId() {
            let clientId = localStorage.getItem('ga_client_id');
            if (!clientId) {
                clientId = Math.random().toString(36).substring(2) + Date.now().toString(36);
                localStorage.setItem('ga_client_id', clientId);
            }
            return clientId;
        }
        
        // 로컬 스토리지에 이벤트 저장
        function saveEventToLocal(eventName, parameters) {
            try {
                const events = JSON.parse(localStorage.getItem('ga_events') || '[]');
                const event = {
                    client_id: generateClientId(),
                    event_name: eventName,
                    parameters: parameters,
                    timestamp: new Date().toISOString(),
                    page_title: parameters.page_title || document.title,
                    page_location: parameters.page_location || window.location.href,
                    user_agent: navigator.userAgent,
                    screen_resolution: `${screen.width}x${screen.height}`,
                    language: navigator.language
                };
                
                events.push(event);
                // 최근 100개 이벤트만 유지
                localStorage.setItem('ga_events', JSON.stringify(events.slice(-100)));
                
                console.log('로컬 이벤트 저장 완료:', eventName, parameters);
                
                // 저장된 이벤트 개수 표시
                console.log(`총 저장된 이벤트: ${events.length}개`);
                
                // 이벤트 내보내기 기능 제공
                if (events.length >= 10) {
                    console.log('이벤트 내보내기 가능: localStorage.getItem("ga_events")');
                }
                
            } catch (error) {
                console.error('로컬 이벤트 저장 실패:', error);
            }
        }
        
        // gtag 함수 구현 (로컬 저장)
        window.gtag = function(command, targetId, parameters) {
            if (command === 'event') {
                const eventName = parameters.event_name || parameters.event_category || 'custom_event';
                saveEventToLocal(eventName, parameters);
            } else if (command === 'config') {
                console.log('GA 설정 저장:', targetId, parameters);
                localStorage.setItem('ga_config', JSON.stringify({
                    measurement_id: targetId,
                    config: parameters,
                    timestamp: new Date().toISOString()
                }));
            }
        };
        
        // 페이지뷰 이벤트 즉시 저장
        saveEventToLocal('page_view', {
            page_title: '절대방어 쇼핑 - 가격비교 사이트',
            page_location: window.location.href,
            page_path: window.location.pathname
        });
        
        console.log('로컬 추적 시스템 활성화됨');
        console.log('저장된 이벤트 확인: localStorage.getItem("ga_events")');
    }
    
    // 페이지 로드 후 Google Analytics 로드
    document.addEventListener('DOMContentLoaded', function() {
        // 약간의 지연 후 로드 (다른 스크립트들이 먼저 로드되도록)
        setTimeout(loadGoogleAnalytics, 100);
    });
    </script>
    
    <link rel="stylesheet" href="style.css">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, orderBy, query, doc, updateDoc, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase 설정 (실제 프로젝트 설정으로 변경하세요)
        // 1. Firebase Console (https://console.firebase.google.com)에서 프로젝트 생성
        // 2. Firestore Database 활성화
        // 3. 프로젝트 설정 > 일반 > 웹 앱에서 설정 복사
const firebaseConfig = {
  apiKey: "AIzaSyB5TXbGISJDljezHHLX93azkB-uixFqQ80",
  authDomain: "price-match-1f952.firebaseapp.com",
  projectId: "price-match-1f952",
  storageBucket: "price-match-1f952.firebasestorage.app",
  messagingSenderId: "630121276155",
  appId: "1:630121276155:web:78337c6ec3270a1457465e",
  measurementId: "G-9V3NBTSTCG"
};
        
        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // 전역 변수로 설정
        window.firebaseApp = app;
        window.firestoreDB = db;
        window.firebaseDb = db; // 호환성을 위한 별칭
        window.firebaseCollection = collection;
        window.firebaseAddDoc = addDoc;
        window.firebaseGetDocs = getDocs;
        window.firebaseOnSnapshot = onSnapshot;
        window.firebaseOrderBy = orderBy;
        window.firebaseQuery = query;
        window.firebaseDoc = doc;
        window.firebaseUpdateDoc = updateDoc;
        window.firebaseWhere = where;
    </script>
</head>
<body>
    <div class="container">
        <!-- 헤더 -->
        <header class="header">
            <div class="header-left">
                <button class="header-btn" onclick="toggleSection('productFormDropdown')">
                    📝 최저가 신고
                </button>
                <div id="productFormDropdown" class="header-dropdown collapsed">
                    <!-- 사용자 타입 선택 -->
                    <div class="user-type-selector">
                        <label class="user-type-option">
                            <input type="radio" name="userType" value="customer" checked>
                            <span>고객 신청</span>
                        </label>
                        <label class="user-type-option">
                            <input type="radio" name="userType" value="admin">
                            <span>관리자 등록</span>
                        </label>
                    </div>

                    <form id="productForm" class="product-form">
                        <div class="form-group">
                            <label for="productName">제품명</label>
                            <input type="text" id="productName" name="productName" placeholder="제품명을 입력하세요" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="productPrice">가격</label>
                            <input type="number" id="productPrice" name="productPrice" placeholder="가격을 입력하세요 (원)" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="productLink">링크</label>
                            <input type="url" id="productLink" name="productLink" placeholder="https://example.com" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="productStore">쇼핑몰</label>
                            <select id="productStore" name="productStore" required>
                                <option value="">쇼핑몰을 선택하세요</option>
                                <option value="쿠팡">쿠팡</option>
                                <option value="네이버쇼핑">네이버쇼핑</option>
                                <option value="11번가">11번가</option>
                                <option value="G마켓">G마켓</option>
                                <option value="옥션">옥션</option>
                                <option value="롯데온">롯데온</option>
                                <option value="기타">기타</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="submit-btn">제품 등록</button>
                    </form>
                    
                    <!-- 감사 메시지 -->
                    <div id="thankYouMessage" class="thank-you-message hidden">
                        <div class="message-content">
                            <h4 id="messageTitle">🎉 감사합니다!</h4>
                            <p id="messageText">제품 정보가 성공적으로 등록되었습니다.</p>
                            <button id="closeMessage" class="close-btn">확인</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="header-center">
                <h1 class="logo">절대방어 쇼핑</h1>
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="상품명을 입력하세요..." class="search-input">
                    <button id="searchBtn" class="search-btn">검색</button>
                </div>
            </div>

            <div class="header-right">
                <button class="header-btn" onclick="toggleSection('adminPanel')">
                    ⚙️ 관리
                </button>
                <div id="adminPanel" class="header-dropdown collapsed">
                    <div class="admin-panel">
                        <div class="admin-controls">
                            <button id="loadPendingProducts" class="admin-btn">승인 대기 제품 보기</button>
                            <button id="loadAllProducts" class="admin-btn">전체 제품 보기</button>
                            <button id="loadPriceReports" class="admin-btn">가격 변경 신고 보기</button>
                            <button id="exportAnalyticsData" class="admin-btn">📊 분석 데이터 내보내기</button>
                        </div>
                        <div id="pendingProductsList" class="pending-products-list"></div>
                    </div>
                </div>
            </div>
        </header>

        <!-- 카테고리 바 -->
        <div class="category-bar">
            <div class="category-item" onclick="filterByCategory('전체')">
                <span class="category-name">전체</span>
                <span class="category-count" id="totalCount">0</span>
            </div>
            <div class="category-item" onclick="filterByCategory('두유')">
                <span class="category-name">두유</span>
                <span class="category-count" id="soyMilkCount">0</span>
            </div>
            <div class="category-item" onclick="filterByCategory('노트북')">
                <span class="category-name">노트북</span>
                <span class="category-count" id="laptopCount">0</span>
            </div>
            <div class="category-item" onclick="filterByCategory('마우스')">
                <span class="category-name">마우스</span>
                <span class="category-count" id="mouseCount">0</span>
            </div>
            <div class="category-item" onclick="filterByCategory('이어폰')">
                <span class="category-name">이어폰</span>
                <span class="category-count" id="earphoneCount">0</span>
            </div>
            <div class="category-item" onclick="filterByCategory('우유')">
                <span class="category-name">우유</span>
                <span class="category-count" id="milkCount">0</span>
            </div>
            <div class="category-item" onclick="filterByCategory('라면')">
                <span class="category-name">라면</span>
                <span class="category-count" id="ramenCount">0</span>
            </div>
            <div class="category-item" onclick="filterByCategory('생수')">
                <span class="category-name">생수</span>
                <span class="category-count" id="waterCount">0</span>
            </div>
            <div class="category-item" onclick="filterByCategory('화장지')">
                <span class="category-name">화장지</span>
                <span class="category-count" id="tissueCount">0</span>
            </div>
            <div class="category-item" onclick="filterByCategory('세제')">
                <span class="category-name">세제</span>
                <span class="category-count" id="detergentCount">0</span>
            </div>
            <div class="category-item" onclick="filterByCategory('샴푸')">
                <span class="category-name">샴푸</span>
                <span class="category-count" id="shampooCount">0</span>
            </div>
            <div class="category-item" onclick="filterByCategory('기저귀')">
                <span class="category-name">기저귀</span>
                <span class="category-count" id="diaperCount">0</span>
            </div>
            <div class="category-item" onclick="filterByCategory('분유')">
                <span class="category-name">분유</span>
                <span class="category-count" id="formulaCount">0</span>
            </div>
            <div class="category-item" onclick="filterByCategory('물티슈')">
                <span class="category-name">물티슈</span>
                <span class="category-count" id="wipesCount">0</span>
            </div>
            <div class="category-item" onclick="filterByCategory('이유식')">
                <span class="category-name">이유식</span>
                <span class="category-count" id="babyFoodCount">0</span>
            </div>
            <div class="category-item" onclick="filterByCategory('기타')">
                <span class="category-name">기타</span>
                <span class="category-count" id="etcCount">0</span>
            </div>
        </div>



        <!-- 검색 결과 -->
        <main class="main-content">
            <div id="loading" class="loading hidden">
                <div class="spinner"></div>
                <p>가격을 비교하고 있습니다...</p>
            </div>

            <div id="searchResults" class="search-results hidden">
                <div id="productList" class="product-list"></div>
            </div>

            <div id="noResults" class="no-results hidden">
                <p>검색 결과가 없습니다. 다른 키워드로 검색해보세요.</p>
            </div>
        </main>
    </div>

    <script src="script.js"></script>
</body>
</html>
